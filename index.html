<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Buddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            width: 24px;
            height: 24px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col flex-shrink-0">
            <div class="p-4 border-b border-gray-700">
                <h1 class="text-xl font-semibold">AI Study Buddy</h1>
            </div>
            <div class="p-4">
                <button id="newChatButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                    + New Chat
                </button>
            </div>
            <nav id="chatList" class="flex-grow overflow-y-auto"></nav>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col">
            <div id="messageContainer" class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <div id="welcomeMessage" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                    <div class="text-5xl mb-4">ðŸ§ </div>
                    <h2 class="text-2xl font-semibold">How can I help you today?</h2>
                </div>
                <!-- Messages will be injected here -->
            </div>
            
            <!-- Input Area -->
            <div class="p-6 bg-white border-t border-gray-200">
                <div class="flex items-center space-x-2">
                    <input type="text" id="questionInput" class="flex-grow border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Ask a question...">
                    <button id="sendButton" class="bg-blue-600 text-white font-semibold rounded-lg px-6 py-3 hover:bg-blue-700 transition flex items-center justify-center disabled:bg-gray-400">
                        <span id="sendButtonText">Send</span>
                        <div id="loader" class="spinner hidden"></div>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirmation Modal for Deletion -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-8 shadow-xl">
            <h3 class="text-lg font-bold mb-4">Confirm Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this chat?</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelDelete" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <script>
        // --- IMPORTANT: Replace with your actual Gemini API Key ---
        const GEMINI_API_KEY = "AIzaSyBgijXSBdKh_Zne40_9lE733lNlXqIFQBc"; 

        // --- DOM Elements ---
        const newChatButton = document.getElementById('newChatButton');
        const chatList = document.getElementById('chatList');
        const messageContainer = document.getElementById('messageContainer');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const questionInput = document.getElementById('questionInput');
        const sendButton = document.getElementById('sendButton');
        const sendButtonText = document.getElementById('sendButtonText');
        const loader = document.getElementById('loader');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');

        // --- Application State ---
        let chats = {};
        let currentChatId = null;
        let isLoading = false;
        let chatToDelete = null;

        // --- Core Functions ---

        function loadChats() {
            const savedChats = localStorage.getItem('ai_study_buddy_chats');
            if (savedChats) chats = JSON.parse(savedChats);
            renderChatList();
        }

        function saveChats() {
            localStorage.setItem('ai_study_buddy_chats', JSON.stringify(chats));
        }

        function renderChatList() {
            chatList.innerHTML = '';
            const sortedChats = Object.entries(chats).sort((a, b) => (b[1].createdAt || 0) - (a[1].createdAt || 0));
            
            sortedChats.forEach(([chatId, chatData]) => {
                const isSelected = currentChatId === chatId;
                const chatItem = document.createElement('div');
                chatItem.className = `flex items-center justify-between p-4 text-sm cursor-pointer ${isSelected ? 'bg-gray-700' : 'hover:bg-gray-700'}`;
                
                const titleSpan = document.createElement('span');
                titleSpan.textContent = chatData.title;
                titleSpan.className = "truncate";
                titleSpan.onclick = () => selectChat(chatId);

                const renameInput = document.createElement('input');
                renameInput.type = 'text';
                renameInput.value = chatData.title;
                renameInput.className = "bg-gray-600 text-white w-full hidden";
                renameInput.onblur = () => finishRename(chatId, renameInput, titleSpan);
                renameInput.onkeypress = (e) => {
                    if (e.key === 'Enter') renameInput.blur();
                };

                const iconsDiv = document.createElement('div');
                iconsDiv.className = 'flex items-center space-x-2 ml-2';

                if (isSelected) {
                    const renameIcon = createIcon('M17.25 2.75L19.25 4.75L13.8437 10.1562L11.8437 8.15625L17.25 2.75ZM10.7812 11.2187L12.7812 13.2187L6.40625 19.5937H4.40625V17.5937L10.7812 11.2187Z');
                    renameIcon.onclick = () => startRename(renameInput, titleSpan);
                    iconsDiv.appendChild(renameIcon);
                }

                const deleteIcon = createIcon('M9.16667 4.16667V5.83333H14.8333V4.16667H9.16667ZM5.83333 7.5V16.6667H18.1667V7.5H5.83333ZM7.5 9.16667H9.16667V15H7.5V9.16667ZM10.8333 9.16667H12.5V15H10.8333V9.16667ZM14.1667 9.16667H15.8333V15H14.1667V9.16667Z');
                deleteIcon.onclick = () => showDeleteModal(chatId);
                
                iconsDiv.appendChild(deleteIcon);
                chatItem.appendChild(titleSpan);
                chatItem.appendChild(renameInput);
                chatItem.appendChild(iconsDiv);
                chatList.appendChild(chatItem);
            });
        }

        function createIcon(pathData) {
            const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            icon.setAttribute('class', 'w-4 h-4 text-gray-400 hover:text-white');
            icon.setAttribute('viewBox', '0 0 24 24');
            icon.setAttribute('fill', 'currentColor');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathData);
            icon.appendChild(path);
            return icon;
        }

        function startRename(input, span) {
            span.classList.add('hidden');
            input.classList.remove('hidden');
            input.focus();
        }

        function finishRename(chatId, input, span) {
            const newTitle = input.value.trim();
            if (newTitle && newTitle !== chats[chatId].title) {
                chats[chatId].title = newTitle;
                saveChats();
            }
            span.classList.remove('hidden');
            input.classList.add('hidden');
            renderChatList();
        }

        function showDeleteModal(chatId) {
            chatToDelete = chatId;
            deleteModal.classList.remove('hidden');
        }
        
        function hideDeleteModal() {
            chatToDelete = null;
            deleteModal.classList.add('hidden');
        }

        function deleteChat() {
            if (!chatToDelete) return;
            delete chats[chatToDelete];
            if (currentChatId === chatToDelete) {
                startNewChat();
            }
            saveChats();
            renderChatList();
            hideDeleteModal();
        }

        function renderMessages() {
            if (!currentChatId || !chats[currentChatId]) {
                 messageContainer.innerHTML = '';
                 messageContainer.appendChild(welcomeMessage);
                 welcomeMessage.classList.remove('hidden');
                 return;
            }
            
            welcomeMessage.classList.add('hidden');
            messageContainer.innerHTML = '';

            chats[currentChatId].messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `mb-4 flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`;
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `max-w-xl p-4 rounded-lg whitespace-pre-wrap ${msg.sender === 'user' ? 'bg-blue-600 text-white' : 'bg-white text-gray-800 shadow-sm'}`;
                bubbleDiv.textContent = msg.text;
                messageDiv.appendChild(bubbleDiv);
                messageContainer.appendChild(messageDiv);
            });
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function startNewChat() {
            currentChatId = null;
            questionInput.value = '';
            renderMessages();
            renderChatList();
        }
        
        function selectChat(chatId) {
            currentChatId = chatId;
            renderMessages();
            renderChatList();
        }
        
        async function sendMessage() {
            const userMessage = questionInput.value.trim();
            if (!userMessage || isLoading) return;

            setLoading(true);

            if (!currentChatId) {
                const newChatId = `chat_${Date.now()}`;
                const title = userMessage.split(' ').slice(0, 5).join(' ');
                chats[newChatId] = { title, messages: [], createdAt: Date.now() };
                currentChatId = newChatId;
                renderChatList();
            }

            chats[currentChatId].messages.push({ text: userMessage, sender: 'user' });
            renderMessages();
            questionInput.value = '';
            saveChats();

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const payload = { contents: [{ parts: [{ text: userMessage }] }] };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const result = await response.json();
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiText) {
                    chats[currentChatId].messages.push({ text: aiText.replace(/[\*#]/g, ''), sender: 'ai' });
                } else {
                    throw new Error("No content received from API.");
                }
            } catch (error) {
                chats[currentChatId].messages.push({ text: `Error: ${error.message}`, sender: 'ai' });
            } finally {
                renderMessages();
                saveChats();
                setLoading(false);
            }
        }

        function setLoading(state) {
            isLoading = state;
            sendButton.disabled = state;
            loader.classList.toggle('hidden', !state);
            sendButtonText.classList.toggle('hidden', state);
        }

        // --- Event Listeners ---
        newChatButton.addEventListener('click', startNewChat);
        sendButton.addEventListener('click', sendMessage);
        questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        cancelDelete.addEventListener('click', hideDeleteModal);
        confirmDelete.addEventListener('click', deleteChat);

        // --- Initial Load ---
        loadChats();
        renderMessages();
    </script>
</body>
</html>

